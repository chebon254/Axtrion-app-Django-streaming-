{% extends 'registration/base.html' %}

{% block content %}
  <div class="container live-container">
    <h2>Live Stream</h2>
    <div id="live-stream-container">
      <!-- Display live stream content here -->
    </div>

    <button onclick="sendLike()">Send Like</button>

    <div id="gift-list">
      {% for gift in gifts %}
        <img src="{{ gift.image.url }}" alt="{{ gift.name }}" onclick="sendGift('{{ gift.id }}')">
      {% endfor %}
    </div>

    <div id="ar-gift-list">
      {% for ar_gift in ar_gifts %}
        <img src="{{ ar_gift.image.url }}" alt="{{ ar_gift.name }}" onclick="sendArGift('{{ ar_gift.id }}')">
      {% endfor %}
    </div>
  
    <textarea id="comment-text"></textarea>
    <button onclick="postComment()">Post Comment</button>
    
    <script>
      const socket = new WebSocket('ws://' + window.location.host + '/ws/live_stream/');

      // Function to send an AR gift
      function sendArGift(arGiftId) {
        // Implement logic to send AR gift (deduct credits, update UI, etc.)
        fetch(`/send_ar_gift/${arGiftId}/`)
          .then(response => response.json())
          .then(data => {
            console.log('AR Gift sent:', data.status);
          })
          .catch(error => {
            console.error('Error sending AR gift:', error);
          });
      }
  
      // Function to send a gift
      function sendGift(giftId) {
        // Implement logic to send gift (deduct credits, update UI, etc.)
        fetch(`/send_gift/${giftId}/`)
          .then(response => response.json())
          .then(data => {
            console.log('Gift sent:', data.status);
          })
          .catch(error => {
            console.error('Error sending gift:', error);
          });
      }

      // Function to send a like
      function sendLike() {
        // Implement logic to send like (deduct credits, update UI, etc.)
        fetch('/send_like/')
          .then(response => response.json())
          .then(data => {
            console.log('Like sent:', data.status);
          })
          .catch(error => {
            console.error('Error sending like:', error);
          });
      }
  
      socket.onopen = function(event) {
        console.log('WebSocket connection opened:', event);
      };
  
      socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const message = data.message;
        const isLike = data.like;
  
        // Handle the received message (update live stream content, display gifts, etc.)
        console.log('Received message:', message);
        // Display likes on the live stream
        if (isLike) {
          const likeContainer = document.getElementById('live-stream-container');
          const likeElement = document.createElement('span');
          likeElement.textContent = '👍';  // You can replace this with your desired like emoji
          likeContainer.appendChild(likeElement);
        }
      };
  
      socket.onclose = function(event) {
        console.log('WebSocket connection closed:', event);
      };

      // Function to post a comment
      function postComment() {
        const commentText = document.getElementById('comment-text').value;
        fetch(`/post_comment/{{ video.id }}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),  // Function to get CSRF token from cookies
          },
          body: JSON.stringify({'text': commentText}),
        })
          .then(response => response.json())
          .then(data => {
            console.log('Comment posted:', data.status);
          })
          .catch(error => {
            console.error('Error posting comment:', error);
          });
      }

      // Function to get CSRF token from cookies
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
  </div>
{% endblock %}